{% extends "base.html" %}

{% block content %}
    <div class="layout-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-dragon"></i> <span class="text-logo">AskDND</span></h1>
                <p>Your AI-powered D&D Rules Companion</p>
                <!-- Mobile header source toggle -->
                <button id="mobile-header-source-toggle" class="mobile-header-source-toggle" title="Toggle Source Panel">
                    <i class="fas fa-book"></i>
                </button>
            </div>
            
            <!-- Vector Store Selector -->
            <div class="vector-store-container">
                <h4>Vector Store</h4>
                <div class="vector-store-selector" id="vector-store-selector">
                    <select id="vector-store-dropdown" class="vector-store-dropdown">
                        {% for store_type in vector_store_types %}
                            <option value="{{ store_type }}" {% if store_type == default_vector_store %}selected{% endif %}>
                                {% if store_type == "standard" or store_type == "pages" %}Page Context{% elif store_type == "semantic" %}Semantic Context{% elif store_type == "haystack-qdrant" %}Haystack (Qdrant){% elif store_type == "haystack-memory" %}Haystack (Memory){% else %}{{ store_type|capitalize }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <button id="vector-store-info-btn" class="vector-store-info-btn" aria-label="Vector Store Information">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            
            <!-- LLM Model Selector -->
            <div class="vector-store-container">
                <h4>LLM Model</h4>
                <div class="vector-store-selector" id="llm-model-selector">
                    <select id="llm-model-dropdown" class="vector-store-dropdown">
                        {% for model_key, model_display_name in available_llm_models.items() %}
                            <option value="{{ model_key }}" {% if model_key == llm_model %}selected{% endif %}>
                                {{ model_display_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-wrapper">
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    <div class="message system welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-dragon"></i>
                        </div>
                        <div class="message-text">
                            <p>Welcome to AskDND! I'm your D&D assistant, ready to help with the 2024 (5.5e) rules. Ask me anything about character creation, combat, spells, or any other rules!</p>
                        </div>
                    </div>
                </div>
                
                <div class="input-container">
                    <textarea id="user-input" placeholder="Ask about D&D rules..." rows="3"></textarea>
                    <button id="send-button">
                        <i class="fas fa-paper-plane"></i>
                        <span>Ask</span>
                    </button>
                </div>
            </div>
            
            <div id="source-panel" class="source-panel">
                <div class="source-panel-header">
                    <h3><i class="fas fa-book-open"></i> Source Content</h3>
                    <div class="zoom-controls">
                        <button id="zoom-in" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                        <button id="zoom-reset" title="Reset Zoom"><i class="fas fa-sync-alt"></i></button>
                        <button id="zoom-out" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                    </div>
                    <div>
                        <button id="expand-panel" class="expand-button" title="Expand"><i class="fas fa-external-link-alt"></i></button>
                        <button id="close-panel" class="close-button">&times;</button>
                    </div>
                </div>
                
                <div class="source-content-wrapper">
                    <!-- Source Pills Container for expanded view -->
                    <div id="source-sources" class="source-sources">
                        <div id="expanded-source-pills"></div>
                    </div>
                    
                    <div id="source-content" class="source-content">
                        <p class="no-source">Select a source to view its content</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Button (Desktop Only) -->
    <div class="admin-button-container desktop-only">
        <button id="admin-button" class="admin-button" title="Admin Panel">
            <i class="fas fa-cog"></i>
        </button>
    </div>
    
    <!-- Admin Modal Overlay -->
    <div id="admin-modal-overlay" class="modal-overlay"></div>
    
    <!-- Admin Modal -->
    <div id="admin-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                <button id="admin-close-button" class="admin-close-button">&times;</button>
            </div>
            <div class="admin-modal-body">
                <div id="admin-login-section">
                    <h3>Admin Access</h3>
                    <div class="admin-form-group">
                        <label for="admin-password">Password</label>
                        <input type="password" id="admin-password" placeholder="Enter admin password">
                    </div>
                    <button id="admin-login-button" class="admin-button">Login</button>
                    <p id="admin-login-error" class="admin-error"></p>
                </div>
                
                <div id="admin-content" class="admin-content" style="display: none;">
                    <div class="admin-tabs">
                        <button class="admin-tab-button active" data-tab="data-processing">Data Processing</button>
                        <button class="admin-tab-button" data-tab="file-management">S3 Files</button>
                        <button class="admin-tab-button" data-tab="vector-db">Qdrant Collections</button>
                        <button class="admin-tab-button" data-tab="api-costs">API Costs</button>
                        <button class="admin-tab-button" data-tab="config">Configuration</button>
                        <button class="admin-tab-button" data-tab="links">External Links</button>
                    </div>
                    
                    <div class="admin-tab-content">
                        <div id="data-processing-tab" class="admin-tab-pane active">
                            
                            <!-- Section 1: Process PDF Documents -->
                            <div class="admin-section">
                                <h4>Process PDF Documents</h4>
                                <div class="admin-form-group">
                                    <label>Vector Store Type</label>
                                    <div class="admin-checkbox-group">
                                        <label><input type="checkbox" value="pages" checked> Page Context</label>
                                        <label><input type="checkbox" value="semantic" checked> Semantic Context</label>
                                        <label><input type="checkbox" value="haystack-qdrant"> Haystack (Qdrant)</label>
                                        <label><input type="checkbox" value="haystack-memory"> Haystack (Memory)</label>
                                    </div>
                                </div>
                                <div class="admin-form-group">
                                    <label>Cache Behavior</label>
                                    <div class="admin-radio-group">
                                        <label><input type="radio" name="cache-behavior" value="use" checked> Use Cache</label>
                                        <label><input type="radio" name="cache-behavior" value="rebuild"> Rebuild Cache</label>
                                    </div>
                                </div>
                                <div class="admin-form-group">
                                    <label for="s3-prefix">S3 PDF Prefix (Optional)</label>
                                    <input type="text" id="s3-prefix" placeholder="source-pdfs/">
                                </div>
                                <button id="process-button" class="admin-button">Process Documents</button>
                            </div>
                            
                            <!-- Section 2: Processing History -->
                            <div class="admin-section">
                                <h4>Processing History</h4>
                                <button id="load-history-button" class="admin-button">Load History</button>
                                <div id="processing-history" class="admin-table-container">
                                    <p>Click "Load History" to view processing history</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="file-management-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>Upload New PDF</h4>
                                <div class="admin-form-group">
                                    <label for="pdf-upload">Select PDF File</label>
                                    <input type="file" id="pdf-upload" accept=".pdf" style="display: none;">
                                    <div id="drop-zone" class="drop-zone">
                                        <p>Drag and drop PDF files here, or <a href="#" id="browse-link">click to browse</a></p>
                                    </div>
                                    <div id="file-list" class="file-list"></div>
                                </div>
                                <div class="admin-form-group">
                                    <label for="upload-prefix">Destination Prefix (Optional)</label>
                                    <input type="text" id="upload-prefix" placeholder="source-pdfs/">
                                </div>
                                <button id="upload-button" class="admin-button">Upload to S3</button>
                                <div id="upload-status" class="admin-status"></div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Existing PDFs</h4>
                                <button id="load-pdfs-button" class="admin-button">List S3 PDFs</button>
                                <div id="pdf-list" class="admin-table-container">
                                    <p>Click "List S3 PDFs" to view existing PDFs</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="vector-db-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>Collection Statistics</h4>
                                <button id="load-collections-button" class="admin-button">Load Collections</button>
                                <div id="collections-stats" class="admin-table-container">
                                    <p>Click "Load Collections" to view collection statistics</p>
                                </div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Collection Points</h4>
                                <div class="admin-form-group">
                                    <label for="collection-select">Select Collection</label>
                                    <select id="collection-select">
                                        <option value="dnd_pdf_pages">Page Context (dnd_pdf_pages)</option>
                                        <option value="dnd_semantic">Semantic (dnd_semantic)</option>
                                        <option value="dnd_haystack">Haystack (dnd_haystack)</option>
                                    </select>
                                </div>
                                <button id="load-points-button" class="admin-button">Load Sample Points</button>
                                <div id="collection-points" class="admin-table-container">
                                    <p>Click "Load Sample Points" to view collection points</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="api-costs-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>OpenAI API Usage</h4>
                                <button id="load-api-costs-button" class="admin-button">Load API Stats</button>
                                <div id="api-costs" class="admin-table-container">
                                    <p>Click "Load API Stats" to view usage information</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="config-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>GPT Configuration</h4>
                                <div class="admin-form-group">
                                    <label for="system-prompt">System Prompt</label>
                                    <textarea id="system-prompt" rows="6" placeholder="Loading current prompt..."></textarea>
                                </div>
                                <button id="save-prompt-button" class="admin-button">Save System Prompt</button>
                                <div id="prompt-status" class="admin-status"></div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Environment Variables</h4>
                                <div id="env-vars" class="admin-table-container">
                                    <p>Loading environment variables...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="links-tab" class="admin-tab-pane">
                            <div class="admin-section admin-links-grid">
                                <a href="https://railway.com/project/48aee718-3bd0-4f4d-afa3-3fe3caf8e8e8?environmentId=5407bbca-8a89-4efd-99b9-2212925870b9" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-train"></i></div>
                                    <div class="admin-link-text">
                                        <h4>Railway</h4>
                                        <p>Deployment Platform</p>
                                    </div>
                                </a>
                                
                                <a href="https://dcc.godaddy.com/control/portfolio/askdnd.ai/settings?ventureId=0d0cb35a-0e7d-4994-9f9a-8fcd059fbe2f&ua_placement=shared_header" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-globe"></i></div>
                                    <div class="admin-link-text">
                                        <h4>GoDaddy</h4>
                                        <p>Domain Registrar</p>
                                    </div>
                                </a>
                                
                                <a href="https://5c301793-8463-48d5-95ac-bd9c542012c0.europe-west3-0.gcp.cloud.qdrant.io:6333/dashboard#/collections" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-database"></i></div>
                                    <div class="admin-link-text">
                                        <h4>Qdrant</h4>
                                        <p>Vector Database</p>
                                    </div>
                                </a>
                                
                                <a href="https://github.com/jettison-v/dndsy" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fab fa-github"></i></div>
                                    <div class="admin-link-text">
                                        <h4>GitHub</h4>
                                        <p>Source Code Repository</p>
                                    </div>
                                </a>
                                
                                <a href="https://platform.openai.com/usage" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-chart-line"></i></div>
                                    <div class="admin-link-text">
                                        <h4>OpenAI Dashboard</h4>
                                        <p>API Usage & Billing</p>
                                    </div>
                                </a>
                                
                                <a href="https://us-east-2.console.aws.amazon.com/s3/buckets/askdnd-ai?region=us-east-2&bucketType=general" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fab fa-aws"></i></div>
                                    <div class="admin-link-text">
                                        <h4>AWS S3</h4>
                                        <p>File Storage</p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="fab-container mobile-only-fab">
        <button id="mobile-source-toggle" class="fab" title="Toggle Source Panel">
            <i class="fas fa-book"></i>
        </button>
    </div>

    <!-- Vector Store Info Modals -->
    <div id="modal-overlay" class="modal-overlay"></div>
    
    <div id="page-context-modal" class="vector-store-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Page Context</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Technical Details</h4>
                <p>The <strong>Page Context</strong> approach processes PDF content page-by-page, maintaining full page context.</p>
                
                <h4>Implementation</h4>
                <ul>
                    <li>Uses <code>all-MiniLM-L6-v2</code> embedding model (384 dimensions)</li>
                    <li>Preserves the entire page as a single document</li>
                    <li>Maintains original page context and structure</li>
                    <li>Processing is done locally without API calls</li>
                    <li>Good for maintaining full page context</li>
                </ul>
                
                <h4>Best For</h4>
                <p>Use this approach when looking for general topics or information that might be spread across a page.</p>
            </div>
        </div>
    </div>
    
    <div id="semantic-context-modal" class="vector-store-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Semantic Context</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Technical Details</h4>
                <p>The <strong>Semantic Context</strong> approach chunks content into paragraphs for more precise, targeted answers.</p>
                
                <h4>Implementation</h4>
                <ul>
                    <li>Uses OpenAI's <code>text-embedding-3-small</code> model (1536 dimensions)</li>
                    <li>Implements intelligent text chunking via <code>RecursiveCharacterTextSplitter</code></li>
                    <li>Analyzes document structure to identify up to 6 levels of hierarchy</li>
                    <li>Tags chunks with full hierarchical path (e.g., "Chapter 5 > Equipment > Weapons")</li>
                    <li>Combines vector similarity search with BM25 for hybrid retrieval</li>
                    <li>Better for retrieving specific pieces of information</li>
                </ul>
                
                <h4>Best For</h4>
                <p>Use this approach for detailed rules questions or when you need precise answers from specific sections.</p>
            </div>
        </div>
    </div>
    
    <div id="haystack-modal" class="vector-store-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Haystack</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Technical Details</h4>
                <p>Haystack provides advanced document retrieval powered by the Haystack framework. We offer two implementations:</p>
                
                <h4>Haystack (Qdrant)</h4>
                <ul>
                    <li>Uses <code>all-MiniLM-L6-v2</code> Sentence Transformer model (384 dimensions)</li>
                    <li>Integrates with Haystack 2.x and QdrantDocumentStore</li>
                    <li>Preserves rich document metadata including page context and hierarchical structure</li>
                    <li>Implements specialized retrieval methods for monster information</li>
                    <li>Provides direct document filtering capabilities using Haystack's filter syntax</li>
                    <li>Stores data in the <code>dnd_haystack</code> Qdrant collection</li>
                </ul>
                
                <h4>Haystack (Memory)</h4>
                <ul>
                    <li>Uses <code>all-MiniLM-L6-v2</code> Sentence Transformer model (384 dimensions)</li>
                    <li>Utilizes Haystack's InMemoryDocumentStore with file persistence</li>
                    <li>Stores document embeddings in memory and persists to disk as PKL files</li>
                    <li>Perfect for deployments without Qdrant or for quick local testing</li>
                    <li>Maintains identical API and functionality with potentially different performance</li>
                </ul>
                
                <h4>Best For</h4>
                <p>Use Haystack when you need specialized queries, particularly for monster information, or when working with complex filtering requirements. Choose Memory implementation for local development/testing and Qdrant for production deployments.</p>
            </div>
        </div>
    </div>

    <!-- Log Modal -->
    <div id="log-modal-overlay" class="modal-overlay" style="z-index: 1050;"></div> <!-- Ensure overlay is below modal -->
    <div id="log-modal" class="admin-modal" style="display: none; z-index: 1051; max-width: 80%; width: 900px;">
        <div class="admin-modal-content" style="height: 80vh;">
            <div class="admin-modal-header">
                <h2 id="log-modal-title">Processing Run Log</h2>
                <button id="log-close-button" class="admin-close-button">&times;</button>
            </div>
            <div class="admin-modal-body" style="height: calc(80vh - 60px); /* Adjust based on header */ display: flex; flex-direction: column;">
                <pre id="log-content" style="flex-grow: 1; overflow-y: auto; background-color: var(--input-bg); padding: 1rem; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">Log content will appear here...</pre>
            </div>
        </div>
    </div>

    <!-- Live Processing Status Modal -->
    <div id="live-status-modal-overlay" class="modal-overlay" style="z-index: 1040;"></div> <!-- Slightly lower z-index -->
    <div id="live-status-modal" class="admin-modal" style="display: none; z-index: 1041; max-width: 70%; width: 800px;">
        <div class="admin-modal-content" style="height: 70vh;">
            <div class="admin-modal-header">
                <h2><i class="fas fa-cogs" style="margin-right: 10px;"></i>Live Processing Status</h2>
                <button id="live-status-close-button" class="admin-close-button">&times;</button>
            </div>
            <div class="admin-modal-body" style="height: calc(70vh - 60px); display: flex; flex-direction: column;">
                <!-- Content moved from live-status-container -->
                <div id="live-status-summary" class="admin-status info" style="margin-bottom: 0.5rem; flex-shrink: 0;">Starting...</div>
                <div id="live-milestones" style="margin-bottom: 0.5rem; flex-shrink: 0;">
                    <!-- Milestones will be added here -->
                </div>
                <div id="live-logs" style="flex-grow: 1; overflow-y: auto; background-color: var(--input-bg); padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap;">
                    <!-- Logs will appear here -->
                </div>
                <button id="cancel-processing-button" class="admin-button" style="margin-top: 0.5rem; background-color: #dc3545; display: none; flex-shrink: 0;">Cancel Run</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Add marked.js for markdown parsing -->
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/admin.js') }}" defer></script>
{% endblock %} 