{% extends "base.html" %}

{% block content %}
    <div class="layout-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-dragon"></i> <span class="text-logo">AskDND</span></h1>
                <p>Your AI-powered D&D Rules Companion</p>
                <!-- Mobile header source toggle -->
                <button id="mobile-header-source-toggle" class="mobile-header-source-toggle" title="Toggle Source Panel">
                    <i class="fas fa-book"></i>
                </button>
            </div>
            
            <!-- Vector Store Selector -->
            <div class="vector-store-container">
                <h4>Vector Store</h4>
                <div class="vector-store-selector" id="vector-store-selector">
                    <select id="vector-store-dropdown" class="vector-store-dropdown">
                        {% for store_type in vector_store_types %}
                            <option value="{{ store_type }}" {% if store_type == default_vector_store %}selected{% endif %}>
                                {% if store_type == "standard" or store_type == "pages" %}Page Context{% elif store_type == "semantic" %}Semantic Context{% elif store_type == "haystack-qdrant" %}Haystack (Qdrant){% elif store_type == "haystack-memory" %}Haystack (Memory){% else %}{{ store_type|capitalize }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                    <button id="vector-store-info-btn" class="vector-store-info-btn" aria-label="Vector Store Information">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            
            <!-- LLM Model Selector -->
            <div class="vector-store-container">
                <h4>LLM Model</h4>
                <div class="vector-store-selector" id="llm-model-selector">
                    <select id="llm-model-dropdown" class="vector-store-dropdown">
                        {% for model_key, model_display_name in available_llm_models.items() %}
                            <option value="{{ model_key }}" {% if model_key == llm_model %}selected{% endif %}>
                                {{ model_display_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- Sidebar Bottom Content -->
            <div class="sidebar-bottom-content">
                <!-- Divider before About Project Button -->
                <div class="sidebar-divider"></div>
                
                <!-- About Project Button -->
                <div class="about-project-container desktop-only">
                    <button id="about-project-button" class="about-project-button">
                        <i class="fas fa-info-circle"></i> About AskDnD
                    </button>
                </div>
                
                <!-- GitHub Repo Button -->
                <div class="about-project-container desktop-only">
                    <button id="github-repo-button" class="about-project-button">
                        <i class="fab fa-github" style="width: 16px; height: 16px; background: none;"></i> GitHub Repo
                    </button>
                </div>
                
                <!-- Admin Settings Button -->
                <div class="admin-container desktop-only">
                    <button id="admin-button" class="admin-settings-button" title="Admin Panel">
                        <i class="fas fa-cog"></i> Admin Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-wrapper">
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    <div class="message system welcome-message">
                        <div class="welcome-icon">
                            <i class="fas fa-dragon"></i>
                        </div>
                        <div class="message-text">
                            <p>Welcome to AskDND! I'm your D&D assistant, ready to help with the 2024 (5.5e) rules. Ask me anything about character creation, combat, spells, or any other rules!</p>
                        </div>
                    </div>
                </div>
                
                <div class="input-container">
                    <textarea id="user-input" placeholder="Ask about D&D rules..." rows="3"></textarea>
                    <button id="send-button">
                        <i class="fas fa-paper-plane"></i>
                        <span>Ask</span>
                    </button>
                </div>
            </div>
            
            <div id="source-panel" class="source-panel">
                <div class="source-panel-header">
                    <h3><i class="fas fa-book-open"></i> Source Content</h3>
                    <div class="zoom-controls">
                        <button id="zoom-in" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                        <button id="zoom-reset" title="Reset Zoom"><i class="fas fa-sync-alt"></i></button>
                        <button id="zoom-out" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                    </div>
                    <div>
                        <button id="expand-panel" class="expand-button" title="Expand"><i class="fas fa-external-link-alt"></i></button>
                        <button id="close-panel" class="close-button">&times;</button>
                    </div>
                </div>
                
                <div class="source-content-wrapper">
                    <!-- Source Pills Container for expanded view -->
                    <div id="source-sources" class="source-sources">
                        <div id="expanded-source-pills"></div>
                    </div>
                    
                    <div id="source-content" class="source-content">
                        <p class="no-source">Select a source to view its content</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Modal Overlay -->
    <div id="admin-modal-overlay" class="modal-overlay"></div>
    
    <!-- Admin Modal -->
    <div id="admin-modal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2><i class="fas fa-shield-alt"></i> Admin Panel</h2>
                <button id="admin-close-button" class="admin-close-button">&times;</button>
            </div>
            <div class="admin-modal-body">
                <div id="admin-login-section">
                    <h3>Admin Access</h3>
                    <div class="admin-form-group">
                        <label for="admin-password">Password</label>
                        <input type="password" id="admin-password" placeholder="Enter admin password">
                    </div>
                    <button id="admin-login-button" class="admin-button">Login</button>
                    <p id="admin-login-error" class="admin-error"></p>
                </div>
                
                <div id="admin-content" class="admin-content" style="display: none;">
                    <div class="admin-tabs">
                        <button class="admin-tab-button active" data-tab="data-processing">Data Processing</button>
                        <button class="admin-tab-button" data-tab="file-management">S3 Files</button>
                        <button class="admin-tab-button" data-tab="vector-db">Qdrant Collections</button>
                        <button class="admin-tab-button" data-tab="api-costs">API Costs</button>
                        <button class="admin-tab-button" data-tab="config">Configuration</button>
                        <button class="admin-tab-button" data-tab="context-inspector">Context Inspector</button>
                        <button class="admin-tab-button" data-tab="links">External Links</button>
                    </div>
                    
                    <div class="admin-tab-content">
                        <div id="data-processing-tab" class="admin-tab-pane active">
                            
                            <!-- Section 1: Process PDF Documents -->
                            <div class="admin-section">
                                <h4>Process PDF Documents</h4>
                                <div class="admin-form-group">
                                    <label>Vector Store Type</label>
                                    <div class="admin-checkbox-group">
                                        <label><input type="checkbox" value="pages" checked> Page Context</label>
                                        <label><input type="checkbox" value="semantic" checked> Semantic Context</label>
                                        <label><input type="checkbox" value="haystack-qdrant"> Haystack (Qdrant)</label>
                                        <label><input type="checkbox" value="haystack-memory"> Haystack (Memory)</label>
                                    </div>
                                </div>
                                <div class="admin-form-group">
                                    <label>Cache Behavior</label>
                                    <div class="admin-radio-group">
                                        <label><input type="radio" name="cache-behavior" value="use" checked> Use Cache</label>
                                        <label><input type="radio" name="cache-behavior" value="rebuild"> Rebuild Cache</label>
                                    </div>
                                </div>
                                <div class="admin-form-group">
                                    <label for="s3-prefix">S3 PDF Prefix (Optional)</label>
                                    <input type="text" id="s3-prefix" placeholder="source-pdfs/">
                                </div>
                                <button id="process-button" class="admin-button">Process Documents</button>
                            </div>
                            
                            <!-- Section 2: Processing History -->
                            <div class="admin-section">
                                <h4>Processing History</h4>
                                <button id="load-history-button" class="admin-button">Load History</button>
                                <div id="processing-history" class="admin-table-container">
                                    <p>Click "Load History" to view processing history</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="file-management-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>Upload New PDF</h4>
                                <div class="admin-form-group">
                                    <label for="pdf-upload">Select PDF File</label>
                                    <input type="file" id="pdf-upload" accept=".pdf" style="display: none;">
                                    <div id="drop-zone" class="drop-zone">
                                        <p>Drag and drop PDF files here, or <a href="#" id="browse-link">click to browse</a></p>
                                    </div>
                                    <div id="file-list" class="file-list"></div>
                                </div>
                                <div class="admin-form-group">
                                    <label for="upload-prefix">Destination Prefix (Optional)</label>
                                    <input type="text" id="upload-prefix" placeholder="source-pdfs/">
                                </div>
                                <button id="upload-button" class="admin-button">Upload to S3</button>
                                <div id="upload-status" class="admin-status"></div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Existing PDFs</h4>
                                <button id="load-pdfs-button" class="admin-button">List S3 PDFs</button>
                                <div id="pdf-list" class="admin-table-container">
                                    <p>Click "List S3 PDFs" to view existing PDFs</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="vector-db-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>Collection Statistics</h4>
                                <button id="load-collections-button" class="admin-button">Load Collections</button>
                                <div id="collections-stats" class="admin-table-container">
                                    <p>Click "Load Collections" to view collection statistics</p>
                                </div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Collection Points</h4>
                                <div class="admin-form-group">
                                    <label for="collection-select">Select Collection</label>
                                    <select id="collection-select">
                                        <option value="dnd_pdf_pages">Page Context (dnd_pdf_pages)</option>
                                        <option value="dnd_semantic">Semantic (dnd_semantic)</option>
                                        <option value="dnd_haystack">Haystack (dnd_haystack)</option>
                                    </select>
                                </div>
                                <button id="load-points-button" class="admin-button">Load Sample Points</button>
                                <div id="collection-points" class="admin-table-container">
                                    <p>Click "Load Sample Points" to view collection points</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="api-costs-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>OpenAI API Usage</h4>
                                <button id="load-api-costs-button" class="admin-button">Load API Stats</button>
                                <div id="api-costs" class="admin-table-container">
                                    <p>Click "Load API Stats" to view usage information</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="config-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>LLM Configuration <i class="fas fa-info-circle help-icon" title="Control the LLM's response style and length"></i></h4>
                                <div class="config-section-help">
                                    These settings control how the AI generates responses, affecting creativity and output length.
                                </div>
                                <div class="admin-form-group">
                                    <label for="llm-temperature">Temperature</label>
                                    <div class="range-with-value">
                                        <input type="range" id="llm-temperature" min="0" max="2" step="0.1" value="0.3">
                                        <span id="llm-temperature-value">0.3</span>
                                    </div>
                                    <span class="help-text">Controls response randomness. Lower values (0.0-0.3) produce more focused, deterministic answers. Higher values (0.7-1.0) create more creative, varied responses.</span>
                                </div>
                                <div class="admin-form-group">
                                    <label for="llm-max-tokens">Max Output Tokens</label>
                                    <input type="number" id="llm-max-tokens" min="100" max="4000" step="50" value="1500">
                                    <span class="help-text">Maximum number of tokens in the AI's response. Higher values allow longer, more detailed answers but may increase response time. (1 token ≈ 4 characters)</span>
                                </div>
                            </div>

                            <div class="admin-section">
                                <h4>Retrieval Parameters <i class="fas fa-info-circle help-icon" title="Control how context is retrieved from the vector database"></i></h4>
                                <div class="config-section-help">
                                    These settings control how many chunks of context are retrieved from the knowledge base and how they're processed before being sent to the LLM.
                                </div>
                                <div class="admin-form-group">
                                    <label for="retrieval-k">Results Count (k)</label>
                                    <input type="number" id="retrieval-k" min="1" max="20" step="1" value="5">
                                    <span class="help-text">Number of final results to include in context. Higher values provide more comprehensive information but may dilute relevance.</span>
                                </div>
                                <div class="admin-form-group">
                                    <label for="retrieval-multiplier">Fetch Multiplier</label>
                                    <input type="number" id="retrieval-multiplier" min="1" max="10" step="1" value="3">
                                    <span class="help-text">Number of candidates fetched is k × multiplier. Higher values cast a wider net for initial retrieval before final ranking.</span>
                                </div>
                                <div class="admin-form-group">
                                    <label for="context-max-per-result">Max Tokens Per Result</label>
                                    <input type="number" id="context-max-per-result" min="100" max="4000" step="100" value="1000">
                                    <span class="help-text">Maximum tokens allowed for each individual context chunk. Limits are applied before sending to the LLM.</span>
                                </div>
                                <div class="admin-form-group">
                                    <label for="context-max-total">Max Total Context Tokens</label>
                                    <input type="number" id="context-max-total" min="1000" max="16000" step="500" value="4000">
                                    <span class="help-text">Maximum combined tokens across all context items. Controls total context size sent to the LLM. Higher values increase accuracy but also increase token usage.</span>
                                </div>
                            </div>

                            <div class="admin-section">
                                <h4>Semantic Search Reranking Weights <i class="fas fa-info-circle help-icon" title="Control the balance between different search techniques"></i></h4>
                                <div class="config-section-help">
                                    These weights control how the Semantic search combines different retrieval approaches. The three weights (α+β+γ) should ideally sum to 1.0.
                                </div>
                                <div class="admin-form-group">
                                    <label for="rerank-alpha">Dense Vector Weight (α)</label>
                                    <div class="range-with-value">
                                        <input type="range" id="rerank-alpha" min="0" max="1" step="0.05" value="0.5">
                                        <span id="rerank-alpha-value">0.5</span>
                                    </div>
                                    <span class="help-text">Weight for semantic vector similarity. Higher values prioritize conceptual matches over exact keyword matches.</span>
                                </div>
                                <div class="admin-form-group">
                                    <label for="rerank-beta">Sparse BM25 Weight (β)</label>
                                    <div class="range-with-value">
                                        <input type="range" id="rerank-beta" min="0" max="1" step="0.05" value="0.3">
                                        <span id="rerank-beta-value">0.3</span>
                                    </div>
                                    <span class="help-text">Weight for lexical BM25 search. Higher values prioritize documents containing query terms with appropriate term frequency/inverse document frequency.</span>
                                </div>
                                <div class="admin-form-group">
                                    <label for="rerank-gamma">Keyword Boost Weight (γ)</label>
                                    <div class="range-with-value">
                                        <input type="range" id="rerank-gamma" min="0" max="1" step="0.05" value="0.2">
                                        <span id="rerank-gamma-value">0.2</span>
                                    </div>
                                    <span class="help-text">Weight for exact keyword matches. Higher values boost documents containing exact query keywords, especially useful for specific terms like spell or monster names.</span>
                                </div>
                                <button id="save-weights-button" class="admin-button">Save Retrieval Settings</button>
                                <div id="weights-status" class="admin-status"></div>
                            </div>

                            <div class="admin-section">
                                <h4>GPT Configuration <i class="fas fa-info-circle help-icon" title="System instructions for the AI model"></i></h4>
                                <div class="config-section-help">
                                    The system prompt defines the AI assistant's behavior, knowledge context, and response guidelines.
                                </div>
                                <div class="admin-form-group">
                                    <label for="system-prompt">System Prompt</label>
                                    <textarea id="system-prompt" rows="6" placeholder="Loading current prompt..."></textarea>
                                    <span class="help-text">Instructions that define how the AI responds. Be specific about tone, format, rules to follow, and any constraints.</span>
                                </div>
                                <button id="save-prompt-button" class="admin-button">Save System Prompt</button>
                                <div id="prompt-status" class="admin-status"></div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Environment Variables <i class="fas fa-info-circle help-icon" title="System configuration values"></i></h4>
                                <div id="env-vars" class="admin-table-container">
                                    <p>Loading environment variables...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="context-inspector-tab" class="admin-tab-pane">
                            <div class="admin-section">
                                <h4>Context Inspector <i class="fas fa-info-circle help-icon" title="Debug which context is retrieved and why"></i></h4>
                                <div class="config-section-help">
                                    This tool helps you debug what content is being sent to the LLM and why it was selected. Enter a query and see the exact context that would be retrieved.
                                </div>
                                <div class="admin-form-group">
                                    <label for="inspector-query">Test Query</label>
                                    <textarea id="inspector-query" rows="2" placeholder="Enter a test query here..."></textarea>
                                    <span class="help-text">Enter a question or query to see what context would be retrieved for it.</span>
                                </div>
                                <div class="admin-form-group">
                                    <label>Vector Store Type</label>
                                    <select id="inspector-store-type" class="vector-store-dropdown">
                                        {% for store_type in vector_store_types %}
                                            <option value="{{ store_type }}" {% if store_type == default_vector_store %}selected{% endif %}>
                                                {% if store_type == "standard" or store_type == "pages" %}Page Context{% elif store_type == "semantic" %}Semantic Context{% elif store_type == "haystack-qdrant" %}Haystack (Qdrant){% elif store_type == "haystack-memory" %}Haystack (Memory){% else %}{{ store_type|capitalize }}{% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <span class="help-text">Select which vector store to use for retrieval.</span>
                                </div>
                                <div class="config-section-help" style="margin-bottom: 10px;">
                                    <small><i class="fas fa-info-circle"></i> The Results Count (k) value is taken from the Configuration tab.</small>
                                </div>
                                <div class="inspector-options">
                                    <label><input type="checkbox" id="inspector-include-detailed" checked> Show Detailed Metrics</label>
                                    <label><input type="checkbox" id="inspector-include-tokens" checked> Show Token Breakdown</label>
                                </div>
                                <button id="inspector-run-button" class="admin-button">Run Query Inspection</button>
                                <div id="inspector-status" class="admin-status"></div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Inspection Results</h4>
                                <div id="inspector-summary" class="config-section-help" style="display: none;">
                                    <div class="inspector-summary-data"></div>
                                </div>
                                <div id="inspector-results" class="admin-table-container">
                                    <p>Run a query above to see the context that would be sent to the LLM.</p>
                                </div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>Context Analysis</h4>
                                <div id="inspector-tokens-chart" class="inspector-chart-container" style="display: none;">
                                    <!-- Token breakdown chart will be rendered here -->
                                </div>
                                <div id="inspector-scores-container" style="display: none;">
                                    <h5>Scores Breakdown</h5>
                                    <div id="inspector-scores-chart" class="inspector-chart-container" style="height: 350px;">
                                        <!-- Scores chart will be rendered here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="admin-section">
                                <h4>LLM Prompt Preview</h4>
                                <div class="admin-form-group">
                                    <div id="inspector-prompt-container" style="display: none;">
                                        <label for="inspector-system-prompt">System Prompt with Retrieved Context</label>
                                        <textarea id="inspector-system-prompt" rows="10" readonly></textarea>
                                        <div class="inspector-token-count" id="inspector-prompt-token-count"></div>
                                    </div>
                                    <p id="inspector-prompt-placeholder">Run a query above to see the complete system prompt that would be sent to the LLM.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="links-tab" class="admin-tab-pane">
                            <div class="admin-section admin-links-grid">
                                <a href="https://railway.com/project/48aee718-3bd0-4f4d-afa3-3fe3caf8e8e8?environmentId=5407bbca-8a89-4efd-99b9-2212925870b9" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-train"></i></div>
                                    <div class="admin-link-text">
                                        <h4>Railway</h4>
                                        <p>Deployment Platform</p>
                                    </div>
                                </a>
                                
                                <a href="https://dcc.godaddy.com/control/portfolio/askdnd.ai/settings?ventureId=0d0cb35a-0e7d-4994-9f9a-8fcd059fbe2f&ua_placement=shared_header" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-globe"></i></div>
                                    <div class="admin-link-text">
                                        <h4>GoDaddy</h4>
                                        <p>Domain Registrar</p>
                                    </div>
                                </a>
                                
                                <a href="https://5c301793-8463-48d5-95ac-bd9c542012c0.europe-west3-0.gcp.cloud.qdrant.io:6333/dashboard#/collections" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-database"></i></div>
                                    <div class="admin-link-text">
                                        <h4>Qdrant</h4>
                                        <p>Vector Database</p>
                                    </div>
                                </a>
                                
                                <a href="https://github.com/jettison-v/dndsy" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fab fa-github"></i></div>
                                    <div class="admin-link-text">
                                        <h4>GitHub</h4>
                                        <p>Source Code Repository</p>
                                    </div>
                                </a>
                                
                                <a href="https://platform.openai.com/usage" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fas fa-chart-line"></i></div>
                                    <div class="admin-link-text">
                                        <h4>OpenAI Dashboard</h4>
                                        <p>API Usage & Billing</p>
                                    </div>
                                </a>
                                
                                <a href="https://us-east-2.console.aws.amazon.com/s3/buckets/askdnd-ai?region=us-east-2&bucketType=general" target="_blank" class="admin-external-link">
                                    <div class="admin-link-icon"><i class="fab fa-aws"></i></div>
                                    <div class="admin-link-text">
                                        <h4>AWS S3</h4>
                                        <p>File Storage</p>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="fab-container mobile-only-fab">
        <button id="mobile-source-toggle" class="fab" title="Toggle Source Panel">
            <i class="fas fa-book"></i>
        </button>
    </div>

    <!-- Vector Store Info Modals -->
    <div id="modal-overlay" class="modal-overlay"></div>
    
    <div id="page-context-modal" class="vector-store-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Page Context</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Technical Details</h4>
                <p>The <strong>Page Context</strong> approach processes PDF content page-by-page, maintaining full page context.</p>
                
                <h4>Implementation</h4>
                <ul>
                    <li>Uses <code>all-MiniLM-L6-v2</code> embedding model (384 dimensions)</li>
                    <li>Preserves the entire page as a single document</li>
                    <li>Maintains original page context and structure</li>
                    <li>Processing is done locally without API calls</li>
                    <li>Good for maintaining full page context</li>
                </ul>
                
                <h4>Best For</h4>
                <p>Use this approach when looking for general topics or information that might be spread across a page.</p>
            </div>
        </div>
    </div>
    
    <div id="semantic-context-modal" class="vector-store-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Semantic Context</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Technical Details</h4>
                <p>The <strong>Semantic Context</strong> approach chunks content into paragraphs for more precise, targeted answers.</p>
                
                <h4>Implementation</h4>
                <ul>
                    <li>Uses OpenAI's <code>text-embedding-3-small</code> model (1536 dimensions)</li>
                    <li>Implements intelligent text chunking via <code>RecursiveCharacterTextSplitter</code></li>
                    <li>Analyzes document structure to identify up to 6 levels of hierarchy</li>
                    <li>Tags chunks with full hierarchical path (e.g., "Chapter 5 > Equipment > Weapons")</li>
                    <li>Combines vector similarity search with BM25 for hybrid retrieval</li>
                    <li>Better for retrieving specific pieces of information</li>
                </ul>
                
                <h4>Best For</h4>
                <p>Use this approach for detailed rules questions or when you need precise answers from specific sections.</p>
            </div>
        </div>
    </div>
    
    <div id="haystack-modal" class="vector-store-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Haystack</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <h4>Technical Details</h4>
                <p>Haystack provides advanced document retrieval powered by the Haystack framework. We offer two implementations:</p>
                
                <h4>Haystack (Qdrant)</h4>
                <ul>
                    <li>Uses <code>all-MiniLM-L6-v2</code> Sentence Transformer model (384 dimensions)</li>
                    <li>Integrates with Haystack 2.x and QdrantDocumentStore</li>
                    <li>Preserves rich document metadata including page context and hierarchical structure</li>
                    <li>Implements specialized retrieval methods for monster information</li>
                    <li>Provides direct document filtering capabilities using Haystack's filter syntax</li>
                    <li>Stores data in the <code>dnd_haystack</code> Qdrant collection</li>
                </ul>
                
                <h4>Haystack (Memory)</h4>
                <ul>
                    <li>Uses <code>all-MiniLM-L6-v2</code> Sentence Transformer model (384 dimensions)</li>
                    <li>Utilizes Haystack's InMemoryDocumentStore with file persistence</li>
                    <li>Stores document embeddings in memory and persists to disk as PKL files</li>
                    <li>Perfect for deployments without Qdrant or for quick local testing</li>
                    <li>Maintains identical API and functionality with potentially different performance</li>
                </ul>
                
                <h4>Best For</h4>
                <p>Use Haystack when you need specialized queries, particularly for monster information, or when working with complex filtering requirements. Choose Memory implementation for local development/testing and Qdrant for production deployments.</p>
            </div>
        </div>
    </div>

    <!-- Log Modal -->
    <div id="log-modal-overlay" class="modal-overlay" style="z-index: 1050;"></div> <!-- Ensure overlay is below modal -->
    <div id="log-modal" class="admin-modal" style="display: none; z-index: 1051; max-width: 80%; width: 900px;">
        <div class="admin-modal-content" style="height: 80vh;">
            <div class="admin-modal-header">
                <h2 id="log-modal-title">Processing Run Log</h2>
                <button id="log-close-button" class="admin-close-button">&times;</button>
            </div>
            <div class="admin-modal-body" style="height: calc(80vh - 60px); /* Adjust based on header */ display: flex; flex-direction: column;">
                <pre id="log-content" style="flex-grow: 1; overflow-y: auto; background-color: var(--input-bg); padding: 1rem; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word;">Log content will appear here...</pre>
            </div>
        </div>
    </div>

    <!-- Live Processing Status Modal -->
    <div id="live-status-modal-overlay" class="modal-overlay" style="z-index: 1040;"></div> <!-- Slightly lower z-index -->
    <div id="live-status-modal" class="admin-modal" style="display: none; z-index: 1041; max-width: 70%; width: 800px;">
        <div class="admin-modal-content" style="height: 70vh;">
            <div class="admin-modal-header">
                <h2><i class="fas fa-cogs" style="margin-right: 10px;"></i>Live Processing Status</h2>
                <button id="live-status-close-button" class="admin-close-button">&times;</button>
            </div>
            <div class="admin-modal-body" style="height: calc(70vh - 60px); display: flex; flex-direction: column;">
                <!-- Content moved from live-status-container -->
                <div id="live-status-summary" class="admin-status info" style="margin-bottom: 0.5rem; flex-shrink: 0;">Starting...</div>
                <div id="live-milestones" style="margin-bottom: 0.5rem; flex-shrink: 0;">
                    <!-- Milestones will be added here -->
                </div>
                <div id="live-logs" style="flex-grow: 1; overflow-y: auto; background-color: var(--input-bg); padding: 0.5rem; border-radius: 4px; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap;">
                    <!-- Logs will appear here -->
                </div>
                <button id="cancel-processing-button" class="admin-button" style="margin-top: 0.5rem; background-color: #dc3545; display: none; flex-shrink: 0;">Cancel Run</button>
            </div>
        </div>
    </div>

    <!-- About Project Modal -->
    <div id="about-project-modal-overlay" class="modal-overlay" style="z-index: 1040;"></div>
    <div id="about-project-modal" class="admin-modal" style="display: none; z-index: 1041; max-width: 80%; width: 900px;">
        <div class="admin-modal-content" style="height: 80vh;">
            <div class="admin-modal-header">
                <h2><i class="fas fa-dragon" style="margin-right: 10px;"></i>About Project AskDnD</h2>
                <button id="about-project-close-button" class="admin-close-button">&times;</button>
            </div>
            <div class="admin-modal-body" style="height: calc(80vh - 60px); display: flex; flex-direction: column;">
                <!-- Tabs Navigation -->
                <div class="admin-tabs">
                    <button class="admin-tab-button active" data-tab="about">About</button>
                    <button class="admin-tab-button" data-tab="tech-stack">Tech Stack</button>
                    <button class="admin-tab-button" data-tab="features">Highlighted Features</button>
                    <button class="admin-tab-button" data-tab="roadmap">Roadmap</button>
                </div>
                
                <!-- Tab Content -->
                <div class="admin-tab-content">
                    <!-- About Tab -->
                    <div id="about-tab" class="admin-tab-pane active">
                        <div class="about-section">
                            <h3>Project Overview</h3>
                            <p>AskDnD is an AI-powered copilot designed to enhance the Dungeons & Dragons experience. It leverages advanced LLM technology combined with Retrieval-Augmented Generation (RAG) to provide accurate, context-aware assistance for players and Dungeon Masters.</p>
                            
                            <h3>Mission</h3>
                            <p>Our mission is to make the D&D experience more accessible and enjoyable by providing instant access to rules, lore, and strategic advice, allowing players to focus on the creative aspects of gameplay.</p>
                            
                            <h3>Core Benefits</h3>
                            <ul>
                                <li><strong>Real-time Rules Assistance</strong>: Accelerate gameplay by answering rules and context-specific questions instantly</li>
                                <li><strong>Balance Creativity & Structure</strong>: Promote rule adherence while maintaining creative freedom</li>
                                <li><strong>Character Development</strong>: Assist players with character creation and optimization</li>
                                <li><strong>Strategic Planning</strong>: Advise on party composition and battle strategy</li>
                            </ul>

                            <h3>Development Approach</h3>
                            <p>AskDnD was built with a focus on accuracy, relevance, and user experience. The system integrates official D&D 2024 materials with specialized retrieval methods to ensure responses are grounded in the actual rules rather than hallucinated content.</p>
                        </div>
                    </div>
                    
                    <!-- Tech Stack Tab -->
                    <div id="tech-stack-tab" class="admin-tab-pane">
                        <div class="about-section">
                            <h3>Technology Overview</h3>
                            <p>AskDnD leverages a modern tech stack focused on delivering accurate, context-aware responses with minimal latency.</p>
                            
                            <h3>Core Technologies</h3>
                            <ul>
                                <li><strong>Backend</strong>: Python, Flask</li>
                                <li><strong>Frontend</strong>: JavaScript, HTML5, CSS3</li>
                                <li><strong>Vector Database</strong>: Qdrant (with both cloud and local deployment options)</li>
                                <li><strong>Storage</strong>: AWS S3 for document and image storage</li>
                                <li><strong>LLM Integration</strong>: OpenAI API (with Claude support in codebase)</li>
                            </ul>
                            
                            <h3>RAG Implementation</h3>
                            <ul>
                                <li><strong>Document Processing</strong>: PyMuPDF for PDF parsing with enhanced link extraction</li>
                                <li><strong>Embedding Models</strong>:
                                    <ul>
                                        <li>OpenAI's text-embedding-3-small (1536 dimensions)</li>
                                        <li>Sentence Transformers all-MiniLM-L6-v2 (384 dimensions)</li>
                                    </ul>
                                </li>
                                <li><strong>Vector Stores</strong>:
                                    <ul>
                                        <li>Page Context: Full-page embeddings maintaining complete context</li>
                                        <li>Semantic Context: Paragraph-level chunks with hierarchical metadata</li>
                                        <li>Haystack: Advanced document retrieval with specialized filtering</li>
                                    </ul>
                                </li>
                                <li><strong>Hybrid Search</strong>: Combined vector similarity and BM25 lexical search</li>
                            </ul>
                            
                            <h3>Deployment</h3>
                            <ul>
                                <li><strong>Hosting</strong>: Railway with customizable environment variables</li>
                                <li><strong>Domain</strong>: Custom domain with SSL</li>
                                <li><strong>Authentication</strong>: Basic password protection</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Highlighted Features Tab -->
                    <div id="features-tab" class="admin-tab-pane">
                        <div class="about-section">
                            <h3>Key Features</h3>
                            
                            <div class="feature-item">
                                <h4>Multiple Retrieval Strategies</h4>
                                <p>AskDnD offers three distinct vector store types that users can switch between depending on their query needs:</p>
                                <ul>
                                    <li><strong>Page Context</strong>: Maintains full page context, ideal for general topics spread across a page</li>
                                    <li><strong>Semantic Context</strong>: Uses paragraph-level chunks with hierarchical metadata for precise answers to specific rules questions</li>
                                    <li><strong>Haystack</strong>: Specialized filtering capabilities for targeted queries, particularly useful for monster information</li>
                                </ul>
                            </div>
                            
                            <div class="feature-item">
                                <h4>Source Citation & Verification</h4>
                                <p>All responses include clickable source citations that open the exact page where information was retrieved, allowing users to verify answers against the official materials.</p>
                            </div>
                            
                            <div class="feature-item">
                                <h4>Intelligent Link Detection</h4>
                                <p>The system extracts and preserves links from source PDFs, including:</p>
                                <ul>
                                    <li>Internal links between PDF sections with correct page jumps</li>
                                    <li>External web links preserved with their original URLs</li>
                                    <li>Color-coded links categorized by content type (monsters, spells, items, etc.)</li>
                                </ul>
                            </div>
                            
                            <div class="feature-item">
                                <h4>Interactive Source Panel</h4>
                                <p>The expandable source panel allows users to:</p>
                                <ul>
                                    <li>View the exact page from source materials</li>
                                    <li>Navigate between pages with prev/next controls</li>
                                    <li>Zoom in/out of source images</li>
                                    <li>Expand the panel for a larger view while maintaining context</li>
                                </ul>
                            </div>
                            
                            <div class="feature-item">
                                <h4>Administrative Tools</h4>
                                <p>The built-in admin interface provides:</p>
                                <ul>
                                    <li>PDF upload and management</li>
                                    <li>Vector store processing with live status updates</li>
                                    <li>Collection statistics and sample points visualization</li>
                                    <li>API usage monitoring</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Roadmap Tab -->
                    <div id="roadmap-tab" class="admin-tab-pane">
                        <div class="about-section">
                            <h3>Project Roadmap</h3>
                            <p>AskDnD is continuously evolving to provide more value to D&D players and DMs. Here are some planned enhancements:</p>
                            
                            <div class="roadmap-section">
                                <h4>Near-Term Improvements</h4>
                                <ul>
                                    <li><strong>Enhanced Image Processing</strong>: Better handling of tables and diagrams in source materials</li>
                                    <li><strong>User Query History</strong>: Save and categorize previous questions and answers</li>
                                    <li><strong>Mobile Optimization</strong>: Further improve the mobile experience for on-the-go rules lookup</li>
                                    <li><strong>Additional Source Materials</strong>: Support for supplemental rulebooks and adventure modules</li>
                                </ul>
                            </div>
                            
                            <div class="roadmap-section">
                                <h4>Feature Expansions</h4>
                                <ul>
                                    <li><strong>Character Sheet Integration</strong>: Allow uploading character sheets for context-aware advice</li>
                                    <li><strong>Campaign Notes</strong>: Integration with DM's campaign notes for game-specific assistance</li>
                                    <li><strong>Combat Tracker</strong>: Interactive initiative and combat state management</li>
                                    <li><strong>Multi-user Collaboration</strong>: Support for party-wide access and shared resources</li>
                                </ul>
                            </div>
                            
                            <div class="roadmap-section">
                                <h4>Technical Enhancements</h4>
                                <ul>
                                    <li><strong>Local LLM Support</strong>: Option to use local LLM models for offline use and privacy</li>
                                    <li><strong>Fine-tuned Models</strong>: D&D-specific fine-tuning for even more accurate responses</li>
                                    <li><strong>Advanced Search Features</strong>: Faceted search, filters, and query templates</li>
                                    <li><strong>Image Generation</strong>: Integration with image models for character and scene visualization</li>
                                </ul>
                            </div>
                            
                            <div class="roadmap-section">
                                <h4>Community Features</h4>
                                <ul>
                                    <li><strong>User Feedback Loop</strong>: Allow users to rate and correct responses</li>
                                    <li><strong>Community Content</strong>: Option to include vetted homebrew and community content</li>
                                    <li><strong>Resource Sharing</strong>: Allow DMs to share custom resources with their players</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Add marked.js for markdown parsing -->
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/admin.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/mobile-ui.js') }}" defer></script>
{% endblock %} 